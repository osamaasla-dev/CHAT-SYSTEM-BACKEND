datasource db {
  provider = "sqlite"
}

generator client {
  provider = "prisma-client-js"
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  AUDIT
}
enum UserStatus {
  PENDING
  ACTIVE
  INACTIVE
  BANNED
}

enum UserRole {
  USER
  ADMIN
}

enum AuthProviderType {
  GOOGLE
  FACEBOOK
  TWITTER
  GITHUB
}

enum ChatType {
  PRIVATE
  GROUP
}

enum ParticipantRole {
  OWNER
  ADMIN
  MEMBER
}

enum MessageContentType {
  TEXT
  EMOJI
  IMAGE
}

enum NotificationType {
  MESSAGE
  MENTION
  SYSTEM
}

enum ThemePreference {
  SYSTEM
  LIGHT
  DARK
}


enum PresenceStatus {
  ONLINE
  OFFLINE
  AWAY
}

enum PrivacyLevel {
  ALL
  CONTACTS
  ONLY_ME
}

model User {
  id              String   @id @default(cuid())
  name            String
  username        String   @unique
  email           String   @unique
  password        String?
  avatarUrl       String?
  avatarPublicId  String?
  role            UserRole @default(USER)

  emailVerifiedAt          DateTime?
  emailVerificationToken   String?   @unique
  emailVerificationExpiresAt DateTime?
  pendingEmail              String?   @unique

  resetPasswordToken       String?   @unique
  resetPasswordExpiresAt   DateTime?

  passwordChangedAt        DateTime?

  status                   UserStatus @default(PENDING)

  lastLoginAt              DateTime?
  statusMessage            String?
  emojiStatus              String?
  presenceStatus           PresenceStatus @default(OFFLINE)
  lastSeenAt               DateTime?

  sessions                 Session[]
  logs                     Log[]
  authProviders            AuthProvider[]
  chatParticipants         ChatParticipant[]
  messages                 Message[]
  messageReactions         MessageReaction[]
  notifications            Notification[]
  blocksInitiated          Block[]    @relation("blocker")
  blocksReceived           Block[]    @relation("blocked")
  contactsOwned            Contact[]  @relation("OwnerContacts")
  contactsReceived         Contact[]  @relation("UserContacts")
  settings                 PrivacySettings?
  notificationSettings     NotificationSettings?
  deletedAt                DateTime? 
}

model AuthProvider {
  id          String   @id @default(cuid())
  userId      String
  provider    AuthProviderType
  providerId  String   
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, providerId])
  @@index([userId])
}

model Session {
  id                 String   @id @default(cuid())
  userId             String
  hashedRefreshToken String?
  expiresAt          DateTime
  revokedAt          DateTime?
  refreshVersion     Int      @default(0)
  ip                 String?
  userAgent          String?
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([hashedRefreshToken])
}

model Log {
  id          String    @id @default(cuid())
  level       LogLevel
  message     String
  userId      String?
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  context     Json?
  requestId   String?
  ip          String?
  method      String?
  path        String?
  statusCode  Int?
  durationMs  Int?
  createdAt   DateTime  @default(now())

  @@index([level])
  @@index([createdAt])
  @@index([userId])
  @@index([path])
}

model Chat {
  id            String      @id @default(cuid())
  type          ChatType    @default(PRIVATE)
  title         String?
  avatarUrl     String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  lastMessageAt DateTime?
  metadata      Json?

  participants  ChatParticipant[]
  messages      Message[]

  @@index([type])
}

model ChatParticipant {
  id                   String          @id @default(cuid())
  chatId               String
  userId               String
  role                 ParticipantRole @default(MEMBER)
  notificationsMuted   Boolean         @default(false)
  muteUntil            DateTime?
  pinnedAt             DateTime?
  lastReadAt           DateTime?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  chat                 Chat            @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user                 User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@index([userId])
}

model Message {
  id            String             @id @default(cuid())
  chatId        String
  senderId      String
  content       String
  contentType   MessageContentType @default(TEXT)
  containsEmoji Boolean            @default(false)
  metadata      Json?
  createdAt     DateTime           @default(now())
  editedAt      DateTime?
  deletedAt     DateTime?

  chat          Chat               @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender        User               @relation(fields: [senderId], references: [id], onDelete: Cascade)
  reactions     MessageReaction[]
  media         Media?

  @@index([chatId])
  @@index([senderId])
}

model Media {
  id        String   @id @default(cuid())
  messageId String   @unique
  imageUrl  String
  publicId  String
  createdAt DateTime @default(now())
  deletedAt DateTime?

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([userId])
}

model PrivacySettings {
  id                   String          @id @default(cuid())
  userId               String          @unique
  onlineVisibility     Boolean         @default(true)
  lastSeenVisibility   Boolean         @default(true)
  readReceiptsVisibility Boolean         @default(true)
  avatarVisibility     PrivacyLevel    @default(CONTACTS)
  allowDirectMessages  PrivacyLevel    @default(ALL)
  usernameSearch       PrivacyLevel    @default(ALL)
  updatedAt            DateTime        @updatedAt

  user                 User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model NotificationSettings {
  id                   String   @id @default(cuid())
  userId               String   @unique
  messageNotifications Boolean  @default(true)
  soundNotifications   Boolean  @default(true)
  notifyOnMentions     Boolean  @default(true)
  updatedAt            DateTime @updatedAt

  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String            @id @default(cuid())
  userId    String
  type      NotificationType  @default(SYSTEM)
  title     String
  body      String?
  data      Json?
  readAt    DateTime?
  createdAt DateTime          @default(now())

  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, readAt])
  @@index([type])
}

model Block {
  id          String   @id @default(cuid())
  blockerId   String
  blockedId   String
  reason      String?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())

  blocker     User     @relation("blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked     User     @relation("blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockedId])
}

model Contact {
  id        String   @id @default(cuid())
  ownerId   String
  contactId String
  createdAt DateTime @default(now())

  owner     User @relation("OwnerContacts", fields: [ownerId], references: [id], onDelete: Cascade)
  contact   User @relation("UserContacts", fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([ownerId, contactId])
  @@index([ownerId])
  @@index([contactId])
}

 
